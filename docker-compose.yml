# docker-compose.yml
# Feelynx Stack (Caddy + API + Frontend + LiveKit + Redis + Postgres + Coturn)

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    restart: unless-stopped
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data

  api:
    image: hashicorp/http-echo:0.2.3
    restart: unless-stopped
    command: ["-text=API OK", "-listen=:4000"]
    ports:
      - "4000:4000"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      API_SECRET: ${API_SECRET}

  frontend:
    image: hashicorp/http-echo:0.2.3
    restart: unless-stopped
    command: ["-text=FRONTEND OK", "-listen=:3000"]
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}

  livekit:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    ports:
      - "7881:7881/udp"
    volumes:
      - ./livekit.yaml:/etc/livekit/livekit.yaml
    command: ["--config", "/etc/livekit/livekit.yaml"]

  coturn:
    image: instrumentisto/coturn
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    command:
      - "--no-tls"
      - "--no-dtls"
      - "--realm=feelynx.live"
      - "--listening-port=3478"
    environment:
      COTURN_SECRET: ${COTURN_SECRET}

  caddy:
    build:
      context: .
      dockerfile: dockerfile
    image: feelynx-caddy:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "7880:7880"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./caddy_data:/data
      - ./caddy_config:/config
    env_file:
      - ./caddy_data/cloudflare.env
    environment:
      CADDY_HOST: ${CADDY_HOST}
    depends_on:
      - frontend
      - api
      - livekit

volumes:
  postgres_data:
  redis_data:
