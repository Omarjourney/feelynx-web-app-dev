name: feelynx-dev

services:
  # Builds the Vite app and publishes the built files to a shared volume
  frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile
    environment:
      - VITE_APP_ENV=production
    volumes:
      - frontend_dist:/dist
    depends_on:
      - backend
    restart: unless-stopped

  # Node.js API (Express) + Socket.io on port 3001
  backend:
    build:
      context: ../../api
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
      - PORT=3001
      - CORS_ORIGIN=https://dev.feelynx.live
    expose:
      - "3001"
    restart: unless-stopped

  # Public reverse proxy with TLS; serves static frontend and proxies API + WebSockets
  nginx:
    image: nginx:1.25-alpine
    depends_on:
      - frontend
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - certs:/etc/letsencrypt/live/dev.feelynx.live:ro
      - frontend_dist:/usr/share/nginx/html:ro
    restart: unless-stopped

volumes:
  # Named volume mapped to host cert directory (uses bind via local driver)
  certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /etc/letsencrypt/live/dev.feelynx.live

  # Where the built frontend (Vite) artifacts are published, then served by Nginx
  frontend_dist:
    driver: local
